/*!
 * @overview  Github.js
 * @copyright (c) 2013 Michael Aufreiter, Development Seed
 *            Github.js is freely distributable.
 * @license   Licensed under MIT license
 *            For all details and documentation:
 *            http://substance.io/michael/github
 */
(function(){"use strict";var t,n;"undefined"!=typeof exports?(t=require("xmlhttprequest").XMLHttpRequest,n=require("underscore"),btoa=require("btoa")):n=window._,"undefined"!=typeof window&&"undefined"!=typeof window.XMLHttpRequest&&(t=window.XMLHttpRequest);var e=function(o){function i(n,e,i,s,r,c){function a(){var t=e.indexOf("//")>=0?e:u+e;return t+(/\?/.test(t)?"&":"?")+(new Date).getTime()}var l=new t;if(l.open(n,a(),!c),c||(l.onreadystatechange=function(){4===this.readyState&&(this.status>=200&&this.status<300||304===this.status?s(null,r?this.responseText:this.responseText?JSON.parse(this.responseText):!0,this):s({path:e,request:this,error:this.status}))}),r?l.setRequestHeader("Accept","application/vnd.github.v3.raw+json"):(l.dataType="json",l.setRequestHeader("Accept","application/vnd.github.v3+json")),l.setRequestHeader("Content-Type","application/json;charset=UTF-8"),o.token||o.username&&o.password){var f=o.token?"token "+o.token:"Basic "+btoa(o.username+":"+o.password);l.setRequestHeader("Authorization",f)}return i?l.send(JSON.stringify(i)):l.send(),c?l.response:void 0}function s(t,e){var o=[];!function s(){i("GET",t,null,function(i,u,r){if(i)return e(i);o.push.apply(o,u);var c=(r.getResponseHeader("link")||"").split(/\s*,\s*/g),a=n.find(c,function(t){return/rel="next"/.test(t)});a&&(a=(/<(.*)>/.exec(a)||[])[1]),a?(t=a,s()):e(i,o)})}()}var u=o.apiUrl||"https://api.github.com";e.User=function(){this.repos=function(t){s("/user/repos?type=all&per_page=1000&sort=updated",function(n,e){t(n,e)})},this.orgs=function(t){i("GET","/user/orgs",null,function(n,e){t(n,e)})},this.gists=function(t){i("GET","/gists",null,function(n,e){t(n,e)})},this.notifications=function(t){i("GET","/notifications",null,function(n,e){t(n,e)})},this.show=function(t,n){var e=t?"/users/"+t:"/user";i("GET",e,null,function(t,e){n(t,e)})},this.userRepos=function(t,n){s("/users/"+t+"/repos?type=all&per_page=1000&sort=updated",function(t,e){n(t,e)})},this.userGists=function(t,n){i("GET","/users/"+t+"/gists",null,function(t,e){n(t,e)})},this.orgRepos=function(t,n){s("/orgs/"+t+"/repos?type=all&&page_num=1000&sort=updated&direction=desc",function(t,e){n(t,e)})},this.follow=function(t,n){i("PUT","/user/following/"+t,null,function(t,e){n(t,e)})},this.unfollow=function(t,n){i("DELETE","/user/following/"+t,null,function(t,e){n(t,e)})},this.createRepo=function(t,n){i("POST","/user/repos",t,n)}},e.Repository=function(t){function o(t,n){return t===a.branch&&a.sha?n(null,a.sha):void r.getRef("heads/"+t,function(e,o){a.branch=t,a.sha=o,n(e,o)})}var s=t.name,u=t.user,r=this,c="/repos/"+u+"/"+s,a={branch:null,sha:null};this.deleteRepo=function(n){i("DELETE",c,t,n)},this.getRef=function(t,n){i("GET",c+"/git/refs/"+t,null,function(t,e){return t?n(t):void n(null,e.object.sha)})},this.createRef=function(t,n){i("POST",c+"/git/refs",t,n)},this.deleteRef=function(n,e){i("DELETE",c+"/git/refs/"+n,t,e)},this.createRepo=function(t,n){i("POST","/user/repos",t,n)},this.deleteRepo=function(n){i("DELETE",c,t,n)},this.listTags=function(t){i("GET",c+"/tags",null,function(n,e){return n?t(n):void t(null,e)})},this.listPulls=function(t,n){i("GET",c+"/pulls"+(t?"?state="+t:""),null,function(t,e){return t?n(t):void n(null,e)})},this.getPull=function(t,n){i("GET",c+"/pulls/"+t,null,function(t,e){return t?n(t):void n(null,e)})},this.compare=function(t,n,e){i("GET",c+"/compare/"+t+"..."+n,null,function(t,n){return t?e(t):void e(null,n)})},this.listBranches=function(t){i("GET",c+"/git/refs/heads",null,function(e,o){return e?t(e):void t(null,n.map(o,function(t){return n.last(t.ref.split("/"))}))})},this.getBlob=function(t,n){i("GET",c+"/git/blobs/"+t,null,n,"raw")},this.getCommit=function(t,n,e){i("GET",c+"/git/commits/"+n,null,function(t,n){return t?e(t):void e(null,n)})},this.getSha=function(t,n,e){return n&&""!==n?void i("GET",c+"/contents/"+n,{ref:t},function(t,n){return t?e(t):void e(null,n.sha)}):r.getRef("heads/"+t,e)},this.getTree=function(t,n){i("GET",c+"/git/trees/"+t,null,function(t,e){return t?n(t):void n(null,e.tree)})},this.postBlob=function(t,n){t="string"==typeof t?{content:t,encoding:"utf-8"}:{content:btoa(String.fromCharCode.apply(null,new Uint8Array(t))),encoding:"base64"},i("POST",c+"/git/blobs",t,function(t,e){return t?n(t):void n(null,e.sha)})},this.updateTree=function(t,n,e,o){var s={base_tree:t,tree:[{path:n,mode:"100644",type:"blob",sha:e}]};i("POST",c+"/git/trees",s,function(t,n){return t?o(t):void o(null,n.sha)})},this.postTree=function(t,n){i("POST",c+"/git/trees",{tree:t},function(t,e){return t?n(t):void n(null,e.sha)})},this.commit=function(n,o,s,u){var r=new e.User;r.show(null,function(e,r){if(e)return u(e);var l={message:s,author:{name:t.user,email:r.email},parents:[n],tree:o};i("POST",c+"/git/commits",l,function(t,n){return t?u(t):(a.sha=n.sha,void u(null,n.sha))})})},this.updateHead=function(t,n,e){i("PATCH",c+"/git/refs/heads/"+t,{sha:n},function(t){e(t)})},this.show=function(t){i("GET",c,null,t)},this.contents=function(t,n,e){i("GET",c+"/contents"+(n?"/"+n:""),{ref:t},e)},this.fork=function(t){i("POST",c+"/forks",null,t)},this.branch=function(t,n,e){2===arguments.length&&"function"==typeof arguments[1]&&(e=n,n=t,t="master"),this.getRef("heads/"+t,function(t,o){return t&&e?e(t):void r.createRef({ref:"refs/heads/"+n,sha:o},e)})},this.createPullRequest=function(t,n){i("POST",c+"/pulls",t,n)},this.listHooks=function(t){i("GET",c+"/hooks",null,t)},this.getHook=function(t,n){i("GET",c+"/hooks/"+t,null,n)},this.createHook=function(t,n){i("POST",c+"/hooks",t,n)},this.editHook=function(t,n,e){i("PATCH",c+"/hooks/"+t,n,e)},this.deleteHook=function(t,n){i("DELETE",c+"/hooks/"+t,null,n)},this.read=function(t,n,e){i("GET",c+"/contents/"+n,{ref:t},function(t,n){return t&&404===t.error?e("not found",null,null):t?e(t):void e(null,n)},!0)},this.remove=function(t,n,e){r.getSha(t,n,function(o,s){return o?e(o):void i("DELETE",c+"/contents/"+n,{message:n+" is removed",sha:s,branch:t},e)})},this["delete"]=function(t,n,e){r.getSha(t,n,function(o,s){if(!s)return e("not found",null);var u=c+"/contents/"+n,r={message:"Deleted "+n,sha:s};u+="?message="+encodeURIComponent(r.message),u+="&sha="+encodeURIComponent(r.sha),u+="&branch="+encodeURIComponent(t),i("DELETE",u,null,e)})},this.move=function(t,e,i,s){o(t,function(o,u){r.getTree(u+"?recursive=true",function(o,c){n.each(c,function(t){t.path===e&&(t.path=i),"tree"===t.type&&delete t.sha}),r.postTree(c,function(n,o){r.commit(u,o,"Deleted "+e,function(n,e){r.updateHead(t,e,function(t){s(t)})})})})})},this.write=function(t,n,e,o,s){r.getSha(t,n,function(u,r){return u&&404!==u.error?s(u):void i("PUT",c+"/contents/"+n,{message:o,content:btoa(e),branch:t,sha:r},s)})},this.getCommits=function(t,n){t=t||{};var e=c+"/commits",o=[];if(t.sha&&o.push("sha="+encodeURIComponent(t.sha)),t.path&&o.push("path="+encodeURIComponent(t.path)),t.since){var s=t.since;s.constructor===Date&&(s=s.toISOString()),o.push("since="+encodeURIComponent(s))}if(t.until){var u=t.until;u.constructor===Date&&(u=u.toISOString()),o.push("until="+encodeURIComponent(u))}t.page&&o.push("page="+t.page),t.perpage&&o.push("per_page="+t.perpage),o.length>0&&(e+="?"+o.join("&")),i("GET",e,null,n)}},e.Gist=function(t){var n=t.id,e="/gists/"+n;this.read=function(t){i("GET",e,null,function(n,e){t(n,e)})},this.create=function(t,n){i("POST","/gists",t,n)},this["delete"]=function(t){i("DELETE",e,null,function(n,e){t(n,e)})},this.fork=function(t){i("POST",e+"/fork",null,function(n,e){t(n,e)})},this.update=function(t,n){i("PATCH",e,t,function(t,e){n(t,e)})},this.star=function(t){i("PUT",e+"/star",null,function(n,e){t(n,e)})},this.unstar=function(t){i("DELETE",e+"/star",null,function(n,e){t(n,e)})},this.isStarred=function(t){i("GET",e+"/star",null,function(n,e){t(n,e)})}},e.Issue=function(t){var n="/repos/"+t.user+"/"+t.repo+"/issues";this.list=function(t,e){var o=[];for(var i in t)t.hasOwnProperty(i)&&o.push(encodeURIComponent(i)+"="+encodeURIComponent(t[i]));s(n+"?"+o.join("&"),e)}},this.getIssues=function(t,n){return new e.Issue({user:t,repo:n})},this.getRepo=function(t,n){return new e.Repository({user:t,name:n})},this.getUser=function(){return new e.User},this.getGist=function(t){return new e.Gist({id:t})}};"undefined"!=typeof exports?module.exports=e:window.Github=e}).call(this);
