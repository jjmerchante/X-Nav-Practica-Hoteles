function showWarning(a){$('<div class="alert alert-warning  alert-dismissible fade in" role="alert"><span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span> <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">×</span></button>'+a+"</div>").appendTo("#alerts-list").delay(4e3).slideUp(500,function(){$("#alerts-list").children(":hidden").alert("close")})}function showInfo(a){$('<div class="alert alert-info  alert-dismissible fade in" role="alert"><span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span> <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">×</span></button>'+a+"</div>").appendTo("#alerts-list").delay(3500).slideUp(500,function(){$("#alerts-list").children(":hidden").alert("close")})}function getAccommodation(a){if(!accomodsDataList)throw showWarning("Carga primero los alojamientos"),"Accommodations haven't been loaded yet";for(var o=null,e=0;e<accomodsDataList.length;e++)if(accomodsDataList[e]["@id"]===a){o=accomodsDataList[e];break}return o}function changeInfo(a){accommodatedUsers=a.accommodatedUsers,myCollections=a.myCollections,actualColl=null,$(".actualCollectionTitle").html(""),$(".collecAccomList").html('<li class="list-group-item list-group-item-warning">No se ha seleccionado ninguna colección</li>'),$("#accommodated-list").html("<p>Ningún usuario se ha alojado.</p>"),accomMarkers.clearLayers(),myCollections.length>0?($("#collectionslist").html(""),myCollections.forEach(function(a){$("#collectionslist").append('<li id="'+a.id+'" class="list-group-item collection">'+a.name+"</li>")}),$("#collectionslist > .collection").click(function(a){showCollection(a.target.id)})):$("#collectionslist").html('<li class="list-group-item list-group-item-warning">No hay colecciones, crea una</li>'),localStorage.setItem("myCollections",JSON.stringify(myCollections)),localStorage.setItem("accommodatedUsers",JSON.stringify(accommodatedUsers))}function loadFromLocalStorage(){var a=localStorage.getItem("myCollections"),o=localStorage.getItem("accommodatedUsers");changeInfo({myCollections:JSON.parse(a)||[],accommodatedUsers:JSON.parse(o)||{}})}function loadOauthLogin(){hello.init({github:"0c2f259e12c21ae95982"},{redirect_uri:"redirect-github.html"});var a=hello("github");a.login({response_type:"code"}).then(function(){var a=hello("github").getAuthResponse();tokenGithubOauth=a.access_token,$("#result-oauth").fadeOut(500).delay(500).removeClass(),$("#result-oauth").addClass("glyphicon glyphicon-ok").delay(500).fadeIn(500)},function(a){console.log(a),showWarning("Error al acceder: "+a.error.message),$("#result-oauth").removeClass(),$("#result-oauth").addClass("glyphicon glyphicon-remove")})}function loadFileRepo(a){a.preventDefault();var o=$("#user-repo").val(),e=$("#repo").val(),t=$("#file").val();if(o&&e&&t){var l=new Github({token:tokenGithubOauth||$("#auth-token").val(),user:$("#auth-user").val(),password:$("#auth-password").val()}),i=l.getRepo(o,e);i.read("master",t,function(a,o){a?showWarning("Error al cargar el archivo: "+a.toString()):(changeInfo(JSON.parse(o)),showInfo("Datos de Github cargados")),$("#user-repo").val(""),$("#repo").val(""),$("#file").val(""),$("#auth-token").val(""),$("#auth-user").val(""),$("#auth-password").val(""),$("#load-save-modal").modal("hide")})}else showWarning("Faltan datos por completar")}function saveInfoRepo(a){a.preventDefault();var o=$("#user-repo").val(),e=$("#repo").val(),t=$("#file").val(),l=$("#auth-token").val()||tokenGithubOauth,i=$("#auth-user").val(),c=$("#auth-password").val();if(o&&e&&t&&(l||i&&c)){var s=new Github({token:l,username:i,password:c,auth:"oauth"}),n=s.getRepo(o,e),r={accommodatedUsers:accommodatedUsers,myCollections:myCollections};n.write("master",t,JSON.stringify(r),"Data saved",function(a){a?(showWarning("No se han podido guardar los datos: "+a.error),console.log(a)):(showInfo("Datos guardados correctamente"),$("#user-repo").val(""),$("#repo").val(""),$("#file").val(""),$("#auth-token").val(""),$("#auth-user").val(""),$("#auth-password").val(""),$("#load-save-modal").modal("hide"))})}else showWarning("Faltan datos por completar")}function loadAccommodations(){var a=$(".loadAccommodBtn").html("Cargando...");$.getJSON("data/alojamientos.json").done(function(o){accomodsDataList=o.serviceList.service,$(".allaccomods").html("");var e="";accomodsDataList.forEach(function(a,o){e+='<li class="list-group-item row"><span id="accommod-'+a["@id"]+'"class="accommodation col-sm-10 col-xs-10">'+a.basicData.title+'</span><span class="glyphicon glyphicon-plus col-sm-2 col-xs-2 add-accom-btn" aria-hidden="true"></span></li>'}),$(".allaccomods").html(e),$(".allaccomods .accommodation").click(showAccommodation),$(".allaccomods li").draggable({revert:"invalid",scroll:!1,helper:"clone"}),$(".add-accom-btn").click(addAccomToCollClick),a.html('Cargados <span class="badge">'+accomodsDataList.length+"</span>")}).fail(function(){$(".allaccomods").html('<li class="list-group-item list-group-item-danger">Error al cargar los alojamientos</li>'),a.html("Reintentar")})}function addAccomToCollClick(a){var o=$(a.target).parent().children(".accommodation")[0],e=o.id.split("-")[1],t=o.innerHTML;addAccomToColl(e,t)}function addClassHoverColl(a){actualColl?$(a.target).addClass("table-hover-good"):$(a.target).addClass("table-hover-bad")}function delClassHoverColl(a){$(a.target).removeClass("table-hover-good table-hover-bad")}function addAccomToCollDrop(a,o){delClassHoverColl(a,o);var e=$(o.draggable[0]).children(".accommodation")[0],t=e.id.split("-")[1],l=e.innerHTML;addAccomToColl(t,l)}function addAccomToColl(a,o){actualColl?actualColl.items.indexOf(a)>-1?showWarning(o+" ya está en la colección"):(actualColl.items.push(a),showCollection(actualColl.id),localStorage.setItem("myCollections",JSON.stringify(myCollections))):showWarning("Tienes que seleccionar primero una colección")}function createCollection(){var a=$("#nameNewCollect").val();if(a){var o={name:a,id:"collec-"+myCollections.length,items:[]};0===myCollections.length&&$("#collectionslist").html(""),myCollections.push(o),localStorage.setItem("myCollections",JSON.stringify(myCollections)),$("#collectionslist").append('<li id="'+o.id+'" class="list-group-item collection">'+o.name+"</li>"),$("#collectionslist > #"+o.id).click(function(a){showCollection(a.target.id)}),showCollection(o.id)}else showWarning("Escribe un nombre de colección");$("#nameNewCollect").val("")}function showCollection(a){actualColl=myCollections[a.split("-")[1]],$(".actualCollectionTitle").html(actualColl.name);var o="",e=[];actualColl.items.forEach(function(a){var t=getAccommodation(a);e.push({coord:[t.geoData.latitude,t.geoData.longitude],name:t.basicData.title,id:t["@id"]}),o+='<li id="accommod-'+t["@id"]+'" class="list-group-item accommodation">'+t.basicData.title+"</li>"}),""===o&&(o+='<li class="list-group-item list-group-item-warning">No hay alojamientos</li>'),$(".collecAccomList").html(o),$(".collecAccomList > .accommodation").click(showAccommodation),changeAccomMarkers(e)}function changeImagesAccom(a){var o="";a.forEach(function(a,e){o+=e%2===0?'<div class="row"><img class="img-responsive col-md-6" src="'+a+'" alt="Foto alojamiento"/>':'<img class="img-responsive col-md-6" src="'+a+'" alt="Foto alojamiento"/></div>'}),a.length%2!==0&&(o+="</div>"),$(".images").html(o),$(".images img").click(function(){$("#img-modal").modal()})}function representCarousel(a){var o=$("#imagesUrlSlider"),e=$("#indicatorsSlider");a.length>0&&(o.html(""),e.html(""),a.forEach(function(a,t){0===t?(e.append('<li data-target="#carousel-images" data-slide-to="0" class="active"></li>'),o.append('<div class="item active"><img src="'+a+'"></div>')):(e.append('<li data-target="#carousel-images" data-slide-to="'+t+'"></li>'),o.append('<div class="item"><img src="'+a+'"></div>'))}),$(".carousel").carousel())}function showAccommodation(a){var o=a.target.id.split("-")[1];actualAccom=getAccommodation(o);var e=[actualAccom.geoData.latitude,actualAccom.geoData.longitude],t=actualAccom.basicData.name,l=actualAccom.extradata.categorias.categoria.item[1]["#text"],i=actualAccom.basicData.body||"<p>No se encontró información acerca de este hotel</p>",c=actualAccom.basicData.web,s=0;"subcategorias"in actualAccom.extradata.categorias.categoria&&"Camping"!==l&&(s=actualAccom.extradata.categorias.categoria.subcategorias.subcategoria.item[1]["#text"].split(" ")[0]);var n=[];actualAccom.multimedia&&actualAccom.multimedia.media&&($.isArray(actualAccom.multimedia.media)?n=actualAccom.multimedia.media.map(function(a){return a.url}):n.push(actualAccom.multimedia.media.url));var r=accommodatedUsers[o]||[];$(".hotel-info").hide("blind",function(){$("a.titleAccommodShow").html(t).attr("href",c),$(".hotel-text").html(i),$(".starsAccommodShow").html("");for(var a=0;s>a;a++)$(".starsAccommodShow").append('<span class="glyphicon glyphicon-star" aria-hidden="true"></span>');changeImagesAccom(n),representCarousel(n),$(".hotel-info").show("blind")}),0===r.length?$("#accommodated-list").html("<p>Ningún usuario se ha alojado.</p>"):($("#accommodated-list").html(""),r.forEach(function(a){gapi.client.load("plus","v1",function(){gapi.client.plus.people.get({userId:a}).execute(function(a){a.error||appendUserAccommodated(a)})})})),actualMarker&&map.removeLayer(actualMarker),actualMarker=L.marker(e).addTo(map).bindPopup(t).openPopup(),map.setView(e,14)}function initGooglePlus(){gapi.client.setApiKey("AIzaSyA4v3iLxJ_gJdlGujFkXgN8y_3YTL2ThOg")}function newUserAccommodated(a){a.preventDefault();var o=$("#google-id-new").val();if(o)if(actualAccom){var e=accommodatedUsers[actualAccom["@id"]];if(e&&e.indexOf(o)>-1)return showWarning("Este usuario ya fue añadido"),void $("#google-id-new").val("");gapi.client.load("plus","v1",function(){gapi.client.plus.people.get({userId:o}).execute(function(a){a.error?showWarning("Problema con el id indicado: "+a.error.message):(accommodatedUsers[actualAccom["@id"]]?accommodatedUsers[actualAccom["@id"]].push(o):accommodatedUsers[actualAccom["@id"]]=[o],$("#google-id-new").val(""),appendUserAccommodated(a),localStorage.setItem("accommodatedUsers",JSON.stringify(accommodatedUsers)))})})}else showWarning("Selecciona un alojamiento");else showWarning("Introduce un identificador de Google+")}function appendUserAccommodated(a){var o='<div class="col-md-4 col-sm-6 panel panel-default gog-person"><div class="panel-body row"><img src="'+a.result.image.url.split("?")[0]+'" class="img-responsive img-circle col-sm-4"/><div class="col-sm-8"><h4>'+a.result.displayName+'</h4><a href="'+a.result.url+'">Perfil Google+</a></div></div></div>',e=!1;$("#accommodated-list").children("p").length>0&&$("#accommodated-list").html(""),$.each($("#accommodated-list").children("div.row"),function(a,t){$(t).children("div").length<3&&!e&&($(t).append(o),e=!0)}),e||$('<div class="row">').appendTo("#accommodated-list").append(o)}function changeAccomMarkers(a){accomMarkers.clearLayers(),a.forEach(function(a){L.marker(a.coord,{icon:pushpin}).addTo(accomMarkers).bindPopup(a.name)})}function startMap(){map=L.map("map",{center:[40.383333,-3.716667],zoom:10}),L.tileLayer("http://{s}.tile.osm.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'}).addTo(map),L.control.layers({},{"Alojamientos de colección":accomMarkers}).addTo(map)}function searchNominatim(a){a.preventDefault();var o=$("#nominatim-input").val();if($("#nominatim-list-result").html(""),o){$("#nominatim-list-result").html('<li class="list-group-item"><div class="progress"><div class="progress-bar progress-bar-striped active" role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100" style="width: 100%"></div></div></li>');var e="http://nominatim.openstreetmap.org/search?countrycodes=es&limit=10&format=json&polygon_geojson=1&q="+o,t="";$.getJSON(e,function(a){$("#nominatim-list-result").html(""),a.forEach(function(a){var o=a.display_name;if(-1!==o.search("Madrid")){o.search(", Área metropolitana de Madrid")&&(o=a.display_name.split(", Área metropolitana de Madrid")[0]);var e="nominatim-"+nominatimResults.length;if(nominatimResults.push(a),a.icon)var l='<img class="media-object" src="'+a.icon+'">';else var l='<span class="glyphicon glyphicon-map-marker" aria-hidden="true"></span>';t+='<li class="list-group-item media nominatim-result" id="'+e+'"><div class="media-left">'+l+'</div><div class="media-body">'+o+"</div></li>"}}),t||(t='<li class="list-group-item">No se ha encontrado ninguna coincidencia en Madrid</li>'),$("#nominatim-list-result").append(t),$(".nominatim-result").click(showResultInMap)})}}function showResultInMap(a){var o=this.id.split("nominatim-")[1],e=nominatimResults[o],t={radius:8,fillColor:"#0000ff",fillOpacity:.5};markerNominatim&&map.removeLayer(markerNominatim),markerNominatim=L.geoJson(e.geojson,{style:{color:"#0000ff",opacity:.5},pointToLayer:function(a,o){return L.circleMarker(o,t)}}).addTo(map),e.boundingbox?map.fitBounds([[e.boundingbox[0],e.boundingbox[2]],[e.boundingbox[1],e.boundingbox[3]]]):map.setView([e.lat,e.lon],15)}function filterList(a){for(var o=$(a.target).parent().children(".listItems").children(),e=a.target.value.toLowerCase(),t=0;t<o.length;t++)$(o[t]).html().toLowerCase().includes(e)?$(o[t]).show():$(o[t]).hide()}var map,accomodsDataList,accomMarkers=new L.LayerGroup,actualMarker,actualAccom=null,myCollections=[],actualColl=null,accommodatedUsers={},tokenGithubOauth="",nominatimResults=[],markerNominatim,pushpin=L.icon({iconUrl:"../images/chincheta.png",iconSize:[37,37],iconAnchor:[2,33],popupAnchor:[20,-30]});$(document).ready(function(){loadFromLocalStorage(),startMap(),$(".loadAccommodBtn").on("click",loadAccommodations),$(".filterList").keyup(filterList),$("#mainTabs a").click(function(a){a.preventDefault(),$(a.target).tab("show")}),$("#createCollectBtn").click(createCollection),$(".actualCollectionPanel").droppable({over:addClassHoverColl,out:delClassHoverColl,drop:addAccomToCollDrop}),$("#load-save-btn").click(function(){$("#load-save-modal").modal()}),$("#load-btn").click(loadFileRepo),$("#save-btn").click(saveInfoRepo),$(".google-id-new-btn").click(newUserAccommodated),$("#oauth").click(loadOauthLogin),$("#nominatim-search").click(searchNominatim)});
